@page "/roof-control"
@using HVO.WebSite.RoofControllerV4.Logic
@using HVO.WebSite.RoofControllerV4.Models
@using Microsoft.AspNetCore.Components.Web
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>Observatory Roof Control - HVOv9</PageTitle>

<div class="roof-control-container">
    <!-- Service Status Banner -->
    @if (!IsServiceAvailable)
    {
        <div class="row mb-3">
            <div class="col-12">
                @if (IsServiceDisposed)
                {
                    <div class="alert service-banner service-banner-danger" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-plug-x-fill me-2 fs-4"></i>
                            <div class="flex-grow-1">
                                <strong>Roof controller service is unavailable</strong>
                                <div class="small text-muted">The underlying service was disposed or stopped. Controls are disabled until it is restored.</div>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="alert service-banner service-banner-warning" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-hourglass-split me-2 fs-4"></i>
                            <div class="flex-grow-1">
                                <strong>Initializing roof controller serviceâ€¦</strong>
                                <div class="small text-muted">Please wait while the service starts. Controls will enable automatically when ready.</div>
                            </div>
                            <div class="ms-3">
                                <div class="spinner-border text-warning" role="status" aria-hidden="true"></div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Header Section with Enhanced Status Display -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white text-center">
                    <h2 class="mb-0">
                        <i class="bi bi-house-door me-2"></i>
                        Hualapai Valley Observatory v9 - Roof Control System
                    </h2>
                    <small class="text-light">Advanced Observatory Automation Platform</small>
                </div>
                <div class="card-body text-center">
                    <div class="status-display mb-3">
                        <h3 class="status-text @GetStatusCssClass()">
                            Status: @CurrentStatus
                        </h3>
                        <div class="status-indicators mb-3">
                            <span class="badge @GetStatusBadgeClass() fs-6 me-2">@CurrentStatus</span>
                            @if (IsInitialized)
                            {
                                <span class="badge bg-success fs-6 me-2">
                                    <i class="bi bi-check-circle me-1"></i>Initialized
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-danger fs-6 me-2">
                                    <i class="bi bi-x-circle me-1"></i>Not Initialized
                                </span>
                            }
                            
                            <!-- Health Check Indicator -->
                            <span class="badge @GetHealthCheckBadgeClass() fs-6 me-2">
                                <i class="bi bi-heart me-1"></i>System Health
                            </span>
                            
                            <!-- Safety Watchdog Status -->
                            @if (IsSafetyWatchdogRunning)
                                {
                                    <span class="@GetWatchdogBadgeClass()">
                                        <i class="bi bi-shield-check me-1"></i>Watchdog: @Math.Ceiling(SafetyWatchdogTimeRemaining)s
                                    </span>
                            }

                            <!-- Last Stop Type (Normal/Emergency) -->
                            @if (!string.IsNullOrEmpty(GetLastStopTypeLabel()))
                            {
                                <span class="@GetLastStopTypeBadgeClass() ms-2" title="Last stop was a @GetLastStopTypeLabel() stop (@LastStopReason)">
                                    <i class="bi bi-stop-circle me-1"></i>@GetLastStopTypeLabel() Stop
                                </span>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (CurrentStatus == RoofControllerStatus.Error)
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-danger d-flex align-items-center" role="alert">
                    <i class="bi bi-exclamation-octagon-fill me-2"></i>
                    <div class="flex-grow-1">
                        <strong>Fault Detected.</strong> Roof controller reported an error. Review system and clear fault when safe.
                    </div>
                    <button class="btn btn-outline-light ms-3"
                            disabled="@IsClearFaultDisabled"
                            @onclick="ClearFaultAsync">
                        <i class="bi bi-bandaid me-1"></i>
                        Clear Fault
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- Hardware Button Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white text-center">
                    <h4 class="mb-0">
                        <i class="bi bi-controller me-2"></i>
                        Observatory Hardware Controls
                    </h4>
                    <small class="text-light">
                        <span>Live Hardware Mode - Buttons control actual roof motors</span>
                    </small>
                </div>
                <div class="card-body">
                    <div class="control-buttons">
                        <div class="d-grid gap-3 d-md-flex justify-content-md-center">
                            <!-- Live Hardware Mode: Direct service calls -->
                            <button class="@GetOpenButtonClass()" 
                                    type="button" 
                                    disabled="@IsOpenDisabled"
                                    @onclick="OpenRoof">
                                <i class="bi bi-arrow-up-circle me-2"></i>
                                Open Roof
                            </button>
                            
                            <button class="@GetStopButtonClass()" 
                                    type="button" 
                                    disabled="@IsStopDisabled"
                                    @onclick="StopRoof">
                                <i class="bi bi-stop-circle me-2"></i>
                                Stop
                            </button>
                            
                            <button class="@GetCloseButtonClass()" 
                                    type="button" 
                                    disabled="@IsCloseDisabled"
                                    @onclick="CloseRoof">
                                <i class="bi bi-arrow-down-circle me-2"></i>
                                Close Roof
                            </button>

                            <button class="btn btn-outline-danger btn-lg control-btn" 
                                    type="button" 
                                    disabled="@IsClearFaultDisabled"
                                    @onclick="ClearFaultAsync">
                                <i class="bi bi-bandaid me-2"></i>
                                Clear Fault
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    

    <!-- Enhanced Safety Information -->
    <div class="row">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark text-center">
                    <h5 class="mb-0">
                        <i class="bi bi-shield-exclamation me-2"></i>
                        Advanced Safety System Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="safety-info">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="bi bi-clock me-1"></i>Automatic Safety Features:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check-circle text-success me-1"></i>@SafetyWatchdogTimeoutSeconds-second safety watchdog timer</li>
                                    <li><i class="bi bi-check-circle text-success me-1"></i>Emergency stop available anytime</li>
                                    <li><i class="bi bi-check-circle text-success me-1"></i>Real-time status monitoring</li>
                                    <li><i class="bi bi-check-circle text-success me-1"></i>Health check system monitoring</li>
                                    <li><i class="bi bi-check-circle text-success me-1"></i>Concurrent operation protection</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="bi bi-exclamation-triangle me-1"></i>Important Notes:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-info-circle text-info me-1"></i>Only one operation at a time</li>
                                    <li><i class="bi bi-info-circle text-info me-1"></i>Monitor weather conditions</li>
                                    <li><i class="bi bi-info-circle text-info me-1"></i>Use Stop for normal interruption; emergency stops are automatic on fault/watchdog</li>
                                    <li><i class="bi bi-info-circle text-info me-1"></i>Watchdog auto-stops long operations</li>
                                    <li><i class="bi bi-info-circle text-info me-1"></i>System validates before each operation</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- System Status Panel -->
                        @if (IsInitialized)
                        {
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="alert alert-info mb-0">
                                        <h6 class="alert-heading">
                                            <i class="bi bi-cpu me-1"></i>System Status & Safety Monitoring
                                        </h6>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <strong>Controller:</strong> @(IsInitialized ? "Ready" : "Initializing...")
                                            </div>
                                            <div class="col-md-3">
                                                <strong>Health Check:</strong> @GetHealthCheckStatus()
                                            </div>
                                            <div class="col-md-6">
                                                <strong>Safety Watchdog:</strong>
                                                @if (IsSafetyWatchdogRunning)
                                                {
                                                    <div>
                                                        <span class="text-warning">
                                                            <i class="bi bi-shield-check me-1"></i>
                                                            <strong>ACTIVE</strong> - @Math.Ceiling(SafetyWatchdogTimeRemaining)s remaining of @SafetyWatchdogTimeoutSeconds-second timeout
                                                        </span>
                                                        <div class="progress mt-1" style="height: 8px;">
                                                                <div class="@GetWatchdogProgressBarClass()" 
                                                                 role="progressbar" 
                                                                 style="width: @((RoofControllerOptions.Value.SafetyWatchdogTimeout.TotalSeconds - SafetyWatchdogTimeRemaining) / RoofControllerOptions.Value.SafetyWatchdogTimeout.TotalSeconds * 100)%"
                                                                 aria-valuenow="@((RoofControllerOptions.Value.SafetyWatchdogTimeout.TotalSeconds - SafetyWatchdogTimeRemaining) / RoofControllerOptions.Value.SafetyWatchdogTimeout.TotalSeconds * 100)" 
                                                                 aria-valuemin="0" 
                                                                 aria-valuemax="100">
                                                            </div>
                                                        </div>
                                                        <small class="text-muted">
                                                            <i class="bi bi-info-circle me-1"></i>
                                                            Emergency stop triggers at timeout to prevent runaway operations
                                                        </small>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div>
                                                        <span class="text-success">
                                                            <i class="bi bi-shield-check me-1"></i>
                                        <div class="row mt-2">
                                            <div class="col-12">
                                                <small class="text-muted" title="@GetLastTransitionTooltip()">
                                                    <i class="bi bi-clock-history me-1"></i>
                                                    Last transition: @GetLastTransitionFriendly()
                                                </small>
                                            </div>
                                        </div>
                                                            <strong>STANDBY</strong> - @SafetyWatchdogTimeoutSeconds-second timeout configured
                                                        </span>
                                                        <div class="progress mt-1" style="height: 8px;">
                                                            <div class="progress-bar bg-success" 
                                                                 role="progressbar" 
                                                                 style="width: 100%"
                                                                 aria-valuenow="100" 
                                                                 aria-valuemin="0" 
                                                                 aria-valuemax="100">
                                                            </div>
                                                        </div>
                                                        <small class="text-muted">
                                                            <i class="bi bi-clock me-1"></i>
                                                            Will activate automatically during roof operations for safety
                                                        </small>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    
</div>

<!-- Toast Container for Notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    @foreach (var notification in Notifications)
    {
        <div class="toast show @GetToastClass(notification.Type)" role="alert" style="@GetToastStyle(notification.Type)">
            <div class="toast-header" style="background-color: rgba(255, 255, 255, 0.1) !important; color: inherit !important; border-bottom: 1px solid rgba(255, 255, 255, 0.2) !important;">
                <i class="@GetToastIcon(notification.Type) me-2" style="color: white !important;"></i>
                <strong class="me-auto" style="color: white !important;">@notification.Title</strong>
                <small style="color: rgba(255, 255, 255, 0.8) !important;">@notification.Timestamp.ToString("HH:mm:ss")</small>
                <button type="button" class="btn-close" @onclick="() => RemoveNotification(notification)" style="filter: brightness(0) invert(1) !important; opacity: 0.8 !important;"></button>
            </div>
            <div class="toast-body" style="color: white !important; font-weight: 500 !important;">
                @notification.Message
            </div>
        </div>
    }
</div>
