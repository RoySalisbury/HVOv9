<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:HVO.Maui.RoofControllerV4.iPad.ViewModels"
             xmlns:converters="clr-namespace:HVO.Maui.RoofControllerV4.iPad.Converters"
             x:Class="HVO.Maui.RoofControllerV4.iPad.MainPage"
             x:DataType="viewModels:RoofControllerViewModel"
             BackgroundColor="#10131A">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:BoolInvertConverter x:Key="BoolInvertConverter" />

            <Style x:Key="BadgeLabelStyle" TargetType="Label">
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="FontSize" Value="14" />
                <Setter Property="TextColor" Value="White" />
            </Style>

            <Style x:Key="CommandButtonStyle" TargetType="Button">
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="FontSize" Value="18" />
                <Setter Property="CornerRadius" Value="14" />
                <Setter Property="Padding" Value="24,16" />
                <Setter Property="HeightRequest" Value="64" />
            </Style>

            <CornerRadius x:Key="CardCorner">24</CornerRadius>
        </ResourceDictionary>
    </ContentPage.Resources>

        <Grid Padding="32"
              RowSpacing="24"
              RowDefinitions="Auto,Auto,Auto,Auto">

            <!-- Row 1: Header & status pills -->
            <VerticalStackLayout Grid.Row="0" Spacing="16">
                <Label Text="Observatory Roof Controller"
                       FontSize="32"
                       FontAttributes="Bold"
                       TextColor="#F8F9FA" />

                <Label Text="Monitor and operate the observatory roof in real time. Safety interlocks and the watchdog halt motion automatically when a fault is detected."
                       TextColor="#CED4DA"
                       FontSize="16"
                       LineHeight="1.35" />

                <FlexLayout Direction="Row"
                            Wrap="Wrap"
                            AlignItems="Center"
                            AlignContent="Center"
                            JustifyContent="Start"
                            Margin="0,4,0,0">
                    <Border BackgroundColor="{Binding InitializationBadgeColor}"
                            Padding="14,8"
                            StrokeThickness="0"
                            Margin="0,0,12,12">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="20" />
                        </Border.StrokeShape>
                        <Label Text="{Binding InitializationBadgeText}" Style="{StaticResource BadgeLabelStyle}" />
                    </Border>

                    <Border BackgroundColor="{Binding HealthBadgeColor}"
                            Padding="14,8"
                            StrokeThickness="0"
                            Margin="0,0,12,12">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="20" />
                        </Border.StrokeShape>
                        <Label Text="Health" Style="{StaticResource BadgeLabelStyle}" />
                    </Border>

                    <Border IsVisible="{Binding ShowStopBadge}"
                            BackgroundColor="{Binding StopBadgeColor}"
                            Padding="14,8"
                            StrokeThickness="0"
                            Margin="0,0,12,12">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="20" />
                        </Border.StrokeShape>
                        <Label Text="{Binding LastStopReasonLabel, StringFormat='{}{0} Stop'}" Style="{StaticResource BadgeLabelStyle}" />
                    </Border>
                </FlexLayout>

                <Border IsVisible="{Binding ShowServiceBanner}"
                        BackgroundColor="{Binding ServiceBannerColor}"
                        Padding="18"
                        StrokeThickness="0"
                        Opacity="0.95">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="18" />
                    </Border.StrokeShape>
                    <VerticalStackLayout Spacing="6">
                        <Label Text="{Binding ServiceBannerTitle}" FontAttributes="Bold" FontSize="18" TextColor="White" />
                        <Label Text="{Binding ServiceBannerMessage}" TextColor="#F8F9FA" FontSize="15" />
                </VerticalStackLayout>
                </Border>

                <Border IsVisible="{Binding HasFault}"
                        BackgroundColor="#DC3545"
                        Padding="18"
                        StrokeThickness="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="18" />
                    </Border.StrokeShape>
                    <VerticalStackLayout Spacing="12">
                        <Label Text="Fault detected. Review the system and clear the fault when safe."
                               TextColor="White"
                               FontSize="18"
                               FontAttributes="Bold"
                               LineBreakMode="WordWrap" />
                        <Button Text="Clear Fault"
                                Command="{Binding ClearFaultCommand}"
                                Style="{StaticResource CommandButtonStyle}"
                                BackgroundColor="Transparent"
                                TextColor="White"
                                BorderWidth="2"
                                BorderColor="White"
                                HorizontalOptions="Start" />
                    </VerticalStackLayout>
                </Border>
        </VerticalStackLayout>

        <!-- Row 2: Controls -->
    <Border Grid.Row="1"
        BackgroundColor="#181C24"
        StrokeThickness="0"
        Padding="20">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="{StaticResource CardCorner}" />
            </Border.StrokeShape>
            <VerticalStackLayout Spacing="20">
                <Label Text="Controls"
                       FontSize="22"
                       FontAttributes="Bold"
                       TextColor="#F8F9FA" />
                <Grid ColumnDefinitions="*,*,*,*" ColumnSpacing="14">
                    <Button Grid.Column="0"
                         Text="Open"
                         Command="{Binding OpenCommand}"
                         Style="{StaticResource CommandButtonStyle}"
                         BackgroundColor="#198754"
                         TextColor="White" />
                    <Button Grid.Column="1"
                         Text="Stop"
                         Command="{Binding StopCommand}"
                         Style="{StaticResource CommandButtonStyle}"
                         BackgroundColor="#FFC107"
                         TextColor="#1B1F24" />
                    <Button Grid.Column="2"
                         Text="Close"
                         Command="{Binding CloseCommand}"
                         Style="{StaticResource CommandButtonStyle}"
                         BackgroundColor="#DC3545"
                         TextColor="White" />
                    <Button Grid.Column="3"
                         Text="Clear Fault"
                         Command="{Binding ClearFaultCommand}"
                         Style="{StaticResource CommandButtonStyle}"
                         BackgroundColor="Transparent"
                         TextColor="#DC3545"
                         BorderColor="#DC3545"
                         BorderWidth="2" />
                </Grid>
            </VerticalStackLayout>
        </Border>

        <!-- Row 3: System Status -->
    <Border Grid.Row="2"
        BackgroundColor="#181C24"
        StrokeThickness="0"
        Padding="20">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="{StaticResource CardCorner}" />
            </Border.StrokeShape>
            <VerticalStackLayout Spacing="18">
                <Label Text="System Status"
                       FontSize="22"
                       FontAttributes="Bold"
                       TextColor="#F8F9FA" />

                <Grid ColumnDefinitions="2*,3*,2*,3*" RowDefinitions="Auto,Auto,Auto" RowSpacing="8" ColumnSpacing="20">
                    <Grid.Resources>
                        <Style TargetType="Label" x:Key="KeyLabelStyle">
                            <Setter Property="FontSize" Value="16" />
                            <Setter Property="TextColor" Value="#ADB5BD" />
                        </Style>
                        <Style TargetType="Label" x:Key="ValueLabelStyle">
                            <Setter Property="FontSize" Value="18" />
                            <Setter Property="TextColor" Value="#F8F9FA" />
                            <Setter Property="LineBreakMode" Value="WordWrap" />
                        </Style>
                    </Grid.Resources>

                    <Label Grid.Column="0"
                           Text="Controller"
                           Style="{StaticResource KeyLabelStyle}" />
                    <Label Grid.Column="1"
                           Text="{Binding StatusText}"
                           Style="{StaticResource ValueLabelStyle}"
                           FontAttributes="Bold" />

                    <Label Grid.Column="2"
                           Text="Health"
                           Style="{StaticResource KeyLabelStyle}" />
                    <Label Grid.Column="3"
                           Text="{Binding HealthStatus}"
                           Style="{StaticResource ValueLabelStyle}" />

                    <Label Grid.Row="1" Grid.Column="0"
                           Text="Movement"
                           Style="{StaticResource KeyLabelStyle}" />
                    <Label Grid.Row="1" Grid.Column="1"
                           Text="{Binding MovementStatus}"
                           Style="{StaticResource ValueLabelStyle}" />

                    <Label Grid.Row="1" Grid.Column="2"
                           Text="Last transition"
                           Style="{StaticResource KeyLabelStyle}" />
                    <Label Grid.Row="1" Grid.Column="3"
                           Text="{Binding LastTransitionDisplay}"
                           Style="{StaticResource ValueLabelStyle}" />

                    <Label Grid.Row="2" Grid.Column="0"
                           Text="Watchdog"
                           Style="{StaticResource KeyLabelStyle}" />
                    <VerticalStackLayout Grid.Row="2" Grid.Column="1" Spacing="6">
                        <Label Text="{Binding WatchdogStatusText}"
                               Style="{StaticResource ValueLabelStyle}"
                               FontSize="16" />
                        <ProgressBar Progress="{Binding WatchdogPercentage}"
                                     HeightRequest="6"
                                     BackgroundColor="#343A40"
                                     ProgressColor="#FFC107"
                                     IsVisible="{Binding IsWatchdogActive}" />
                        <Label Text="{Binding WatchdogSecondaryText}"
                               Style="{StaticResource ValueLabelStyle}"
                               FontSize="14" />
                    </VerticalStackLayout>

                    <Label Grid.Row="2" Grid.Column="2"
                           Text="Fault"
                           Style="{StaticResource KeyLabelStyle}" />
              <Label Grid.Row="2" Grid.Column="3"
                  Text="{Binding LastErrorMessage, TargetNullValue=—, FallbackValue=—}"
                  Style="{StaticResource ValueLabelStyle}" />
                </Grid>
            </VerticalStackLayout>
        </Border>

        <!-- Row 4: Latest Activity -->
    <Border Grid.Row="3"
        BackgroundColor="#181C24"
        StrokeThickness="0"
        Padding="20">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="{StaticResource CardCorner}" />
            </Border.StrokeShape>
            <VerticalStackLayout x:Name="LatestActivityStack" Spacing="14">
                <Label x:Name="LatestActivityTitle"
                       Text="Latest Activity"
                       FontSize="22"
                       FontAttributes="Bold"
                       TextColor="#F8F9FA" />

                <Grid x:Name="LatestActivityGrid" ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto" ColumnSpacing="20" RowSpacing="10">
                    <Grid.Resources>
                        <Style TargetType="Label" x:Key="ActivityKeyStyle">
                            <Setter Property="FontSize" Value="16" />
                            <Setter Property="TextColor" Value="#ADB5BD" />
                        </Style>
                        <Style TargetType="Label" x:Key="ActivityValueStyle">
                            <Setter Property="FontSize" Value="18" />
                            <Setter Property="TextColor" Value="#F8F9FA" />
                            <Setter Property="LineBreakMode" Value="WordWrap" />
                        </Style>
                    </Grid.Resources>

                    <Label Grid.Row="0"
                           Text="Title"
                           Style="{StaticResource ActivityKeyStyle}" />
                    <Label Grid.Row="0" Grid.Column="1"
                           Text="{Binding LatestNotification.Title, TargetNullValue=No recent activity, FallbackValue=No recent activity}"
                           Style="{StaticResource ActivityValueStyle}" FontAttributes="Bold" />

                    <Label Grid.Row="1"
                           Text="Details"
                           Style="{StaticResource ActivityKeyStyle}" />
                    <StackLayout Grid.Row="1" Grid.Column="1" Spacing="4">
                        <Label Text="{Binding LatestNotification.Message, TargetNullValue=Command results and status updates will appear here., FallbackValue=Command results and status updates will appear here.}"
                               Style="{StaticResource ActivityValueStyle}" />
                        <Label Text="{Binding LatestNotification.Timestamp, StringFormat='{}{0:HH:mm:ss}'}"
                               TextColor="#868E96"
                               FontSize="13"
                               IsVisible="{Binding HasLatestNotification}" />
                    </StackLayout>
                </Grid>

                <Label x:Name="LatestActivityMessage"
                       Text="Only one roof motion runs at a time. Use Stop to interrupt manually; emergency stops trigger automatically for faults or watchdog timeouts."
                       TextColor="#ADB5BD"
                       FontSize="13"
                       LineHeight="1.3" />
            </VerticalStackLayout>

            <VisualStateManager.VisualStateGroups>
                <VisualStateGroup>
                    <VisualState Name="Portrait">
                        <VisualState.StateTriggers>
                            <OrientationStateTrigger Orientation="Portrait" />
                        </VisualState.StateTriggers>
                        <VisualState.Setters>
                            <Setter TargetName="LatestActivityTitle" Property="IsVisible" Value="True" />
                            <Setter TargetName="LatestActivityGrid" Property="IsVisible" Value="True" />
                        </VisualState.Setters>
                    </VisualState>
                    <VisualState Name="Landscape">
                        <VisualState.StateTriggers>
                            <OrientationStateTrigger Orientation="Landscape" />
                        </VisualState.StateTriggers>
                        <VisualState.Setters>
                            <Setter TargetName="LatestActivityTitle" Property="IsVisible" Value="False" />
                            <Setter TargetName="LatestActivityGrid" Property="IsVisible" Value="False" />
                            <Setter TargetName="LatestActivityMessage" Property="Margin" Value="0" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateManager.VisualStateGroups>
        </Border>

    </Grid>

</ContentPage>
