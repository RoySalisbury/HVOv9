<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:HVO.Maui.RoofControllerV4.iPad.ViewModels"
             xmlns:models="clr-namespace:HVO.Maui.RoofControllerV4.iPad.Models"
             xmlns:converters="clr-namespace:HVO.Maui.RoofControllerV4.iPad.Converters"
             x:Class="HVO.Maui.RoofControllerV4.iPad.MainPage"
             x:DataType="viewModels:RoofControllerViewModel"
             BackgroundColor="#10131A">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:StringHasValueConverter x:Key="StringHasValueConverter" />
            <converters:StringHasValueConverter x:Key="StringMissingConverter" Invert="True" />
            <converters:BoolInvertConverter x:Key="BoolInvertConverter" />

            <Style x:Key="BadgeLabelStyle" TargetType="Label">
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="FontSize" Value="14" />
                <Setter Property="TextColor" Value="White" />
            </Style>

            <Style x:Key="CommandButtonStyle" TargetType="Button">
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="FontSize" Value="20" />
                <Setter Property="CornerRadius" Value="14" />
                <Setter Property="Padding" Value="28,18" />
                <Setter Property="HeightRequest" Value="80" />
            </Style>

            <CornerRadius x:Key="CardCorner">24</CornerRadius>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="36,40" Spacing="28">
            <!-- Header Section -->
            <Grid ColumnSpacing="28">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="420" />
                </Grid.ColumnDefinitions>

                <VerticalStackLayout Grid.Column="0" Spacing="18">
                    <Label Text="Observatory Roof Controller"
                           FontSize="34"
                           FontAttributes="Bold"
                           TextColor="#F8F9FA" />

                    <Label Text="Manage the observatory roof using the same controls as the HVO RoofController web experience. Safety systems and watchdog timers ensure the motors stop automatically if a fault occurs."
                           TextColor="#CED4DA"
                           FontSize="18"
                           LineHeight="1.4" />

                    <FlexLayout Direction="Row"
                                Wrap="Wrap"
                                AlignItems="Center"
                                AlignContent="Center">
                        <Border BackgroundColor="{Binding InitializationBadgeColor}"
                                Padding="16,8"
                                StrokeThickness="0"
                                Margin="0,0,12,12">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="20" />
                            </Border.StrokeShape>
                            <Label Text="{Binding InitializationBadgeText}" Style="{StaticResource BadgeLabelStyle}" />
                        </Border>

                        <Border BackgroundColor="{Binding HealthBadgeColor}"
                                Padding="16,8"
                                StrokeThickness="0"
                                Margin="0,0,12,12">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="20" />
                            </Border.StrokeShape>
                            <Label Text="Health" Style="{StaticResource BadgeLabelStyle}" />
                        </Border>

                        <Border IsVisible="{Binding ShowStopBadge}"
                                BackgroundColor="{Binding StopBadgeColor}"
                                Padding="16,8"
                                StrokeThickness="0"
                                Margin="0,0,12,12">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="20" />
                            </Border.StrokeShape>
                            <Label Text="{Binding LastStopReasonLabel, StringFormat='{}{0} Stop'}" Style="{StaticResource BadgeLabelStyle}" />
                        </Border>
                    </FlexLayout>

                    <Border IsVisible="{Binding ShowServiceBanner}"
                            BackgroundColor="{Binding ServiceBannerColor}"
                            Padding="18"
                            StrokeThickness="0"
                            Opacity="0.95">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="18" />
                        </Border.StrokeShape>
                        <VerticalStackLayout Spacing="6">
                            <Label Text="{Binding ServiceBannerTitle}" FontAttributes="Bold" FontSize="18" TextColor="White" />
                            <Label Text="{Binding ServiceBannerMessage}" TextColor="#F8F9FA" FontSize="15" />
                        </VerticalStackLayout>
                    </Border>

                    <Border IsVisible="{Binding HasFault}"
                            BackgroundColor="#DC3545"
                            Padding="18"
                            StrokeThickness="0">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="18" />
                        </Border.StrokeShape>
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="18" VerticalOptions="Center">
                            <Label Grid.Column="0"
                                   Text="Fault detected. Review the system and clear the fault when safe."
                                   TextColor="White"
                                   FontSize="18"
                                   FontAttributes="Bold" />
                            <Button Grid.Column="1"
                                    Text="Clear Fault"
                                    Command="{Binding ClearFaultCommand}"
                                    Style="{StaticResource CommandButtonStyle}"
                                    BackgroundColor="Transparent"
                                    TextColor="White"
                                    BorderWidth="2"
                                    BorderColor="White"
                                    Padding="22,14"
                                    HeightRequest="64" />
                        </Grid>
                    </Border>
                </VerticalStackLayout>

                <!-- Camera Preview -->
        <Border Grid.Column="1"
            BackgroundColor="#1B1F27"
            StrokeThickness="0"
            HeightRequest="320"
            Padding="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="{StaticResource CardCorner}" />
                    </Border.StrokeShape>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>
                        <Grid Padding="24" ColumnDefinitions="*,Auto" BackgroundColor="#222630">
                            <Label Grid.Column="0"
                                   Text="Roof Camera"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="#F8F9FA" />
                            <Label Grid.Column="1" Text="Preview" TextColor="#ADB5BD" FontSize="14" />
                        </Grid>
                        <Grid Grid.Row="1" BackgroundColor="#13161F" Padding="0">
                            <WebView Source="{Binding CameraStreamUrl}"
                                     IsVisible="{Binding CameraStreamUrl, Converter={StaticResource StringHasValueConverter}}"
                                     HorizontalOptions="Fill"
                                     VerticalOptions="Fill" />
                            <VerticalStackLayout IsVisible="{Binding CameraStreamUrl, Converter={StaticResource StringMissingConverter}}"
                                                Spacing="8"
                                                VerticalOptions="Center"
                                                HorizontalOptions="Center"
                                                Padding="24">
                                <Label Text="Live camera preview unavailable"
                                       TextColor="#ADB5BD"
                                       FontSize="17"
                                       HorizontalTextAlignment="Center" />
                                <Label Text="Configure the stream URL in appsettings.json to enable the video feed."
                                       TextColor="#6C757D"
                                       FontSize="14"
                                       LineHeight="1.3"
                                       HorizontalTextAlignment="Center" />
                            </VerticalStackLayout>
                        </Grid>
                    </Grid>
                </Border>
            </Grid>

            <!-- Control and Status Panels -->
            <Grid ColumnSpacing="28">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

        <Border Grid.Column="0"
            BackgroundColor="#181C24"
            StrokeThickness="0"
            Padding="28">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="{StaticResource CardCorner}" />
                    </Border.StrokeShape>
                    <VerticalStackLayout Spacing="24">
                        <Label Text="Controls"
                               FontSize="22"
                               FontAttributes="Bold"
                               TextColor="#F8F9FA" />
                <Grid ColumnSpacing="18" RowSpacing="18"
                    ColumnDefinitions="*,*"
                    RowDefinitions="Auto,Auto">
                            <Button Grid.Row="0" Grid.Column="0"
                                    Text="Open"
                                    Command="{Binding OpenCommand}"
                                    Style="{StaticResource CommandButtonStyle}"
                                    BackgroundColor="#198754"
                                    TextColor="White" />
                            <Button Grid.Row="0" Grid.Column="1"
                                    Text="Stop"
                                    Command="{Binding StopCommand}"
                                    Style="{StaticResource CommandButtonStyle}"
                                    BackgroundColor="#FFC107"
                                    TextColor="#1B1F24" />
                            <Button Grid.Row="1" Grid.Column="0"
                                    Text="Close"
                                    Command="{Binding CloseCommand}"
                                    Style="{StaticResource CommandButtonStyle}"
                                    BackgroundColor="#DC3545"
                                    TextColor="White" />
                            <Button Grid.Row="1" Grid.Column="1"
                                    Text="Clear Fault"
                                    Command="{Binding ClearFaultCommand}"
                                    Style="{StaticResource CommandButtonStyle}"
                                    BackgroundColor="Transparent"
                                    TextColor="#DC3545"
                                    BorderColor="#DC3545"
                                    BorderWidth="2" />
                        </Grid>
                    </VerticalStackLayout>
                </Border>

        <Border Grid.Column="1"
            BackgroundColor="#181C24"
            StrokeThickness="0"
            Padding="28">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="{StaticResource CardCorner}" />
                    </Border.StrokeShape>
                    <VerticalStackLayout Spacing="18">
                        <Label Text="System Status"
                               FontSize="22"
                               FontAttributes="Bold"
                               TextColor="#F8F9FA" />

                        <Grid RowSpacing="16" ColumnSpacing="24" ColumnDefinitions="Auto,*">
                            <Label Text="Controller" Grid.Column="0" TextColor="#ADB5BD" FontSize="16" />
                            <Label Text="{Binding StatusText}" Grid.Column="1" TextColor="#F8F9FA" FontSize="18" FontAttributes="Bold" />

                            <Label Text="Health" Grid.Row="1" Grid.Column="0" TextColor="#ADB5BD" FontSize="16" />
                            <Label Text="{Binding HealthStatus}" Grid.Row="1" Grid.Column="1" TextColor="#F8F9FA" FontSize="18" />

                            <Label Text="Movement" Grid.Row="2" Grid.Column="0" TextColor="#ADB5BD" FontSize="16" />
                            <Label Text="{Binding MovementStatus}" Grid.Row="2" Grid.Column="1" TextColor="#F8F9FA" FontSize="18" />

                            <Label Text="Last transition" Grid.Row="3" Grid.Column="0" TextColor="#ADB5BD" FontSize="16" />
                            <Label Text="{Binding LastTransitionDisplay}" Grid.Row="3" Grid.Column="1" TextColor="#F8F9FA" FontSize="18" />

                            <Label Text="Watchdog" Grid.Row="4" Grid.Column="0" TextColor="#ADB5BD" FontSize="16" />
                            <StackLayout Grid.Row="4" Grid.Column="1" Spacing="6">
                                <Label Text="{Binding WatchdogStatusText}" TextColor="#F8F9FA" />
                                <ProgressBar Progress="{Binding WatchdogPercentage}"
                                             HeightRequest="6"
                                             BackgroundColor="#343A40"
                                             ProgressColor="#FFC107"
                                             IsVisible="{Binding IsWatchdogActive}" />
                                <Label Text="{Binding WatchdogSecondaryText}"
                                       TextColor="#ADB5BD" />
                            </StackLayout>
                        </Grid>
                    </VerticalStackLayout>
                </Border>
            </Grid>

            <!-- Notifications -->
        <Border BackgroundColor="#181C24"
            StrokeThickness="0"
            Padding="24">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="{StaticResource CardCorner}" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="18">
                    <Label Text="Activity"
                           FontSize="22"
                           FontAttributes="Bold"
                           TextColor="#F8F9FA" />
                    <VerticalStackLayout Spacing="12"
                                          BindableLayout.ItemsSource="{Binding Notifications}"
                                          IsVisible="{Binding HasNotifications}">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="models:NotificationItem">
                                <Border Padding="16"
                                        StrokeThickness="0"
                                        BackgroundColor="#1F2531"
                                        Opacity="0.95">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="16" />
                                    </Border.StrokeShape>
                                    <VerticalStackLayout Spacing="4">
                                        <Label Text="{Binding Title}" FontAttributes="Bold" TextColor="#F8F9FA" />
                                        <Label Text="{Binding Message}" TextColor="#CED4DA" />
                                        <Label Text="{Binding Timestamp, StringFormat='{}{0:HH:mm:ss}'}" TextColor="#868E96" FontSize="12" />
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>
                    <Label Text="Events such as commands, status changes, and safety notices appear here."
                           IsVisible="{Binding HasNotifications, Converter={StaticResource BoolInvertConverter}}"
                           TextColor="#868E96"
                           FontSize="14"
                           LineHeight="1.4" />
                </VerticalStackLayout>
            </Border>

            <Label Text="Only one roof motion may run at a time. Use Stop to interrupt manually; emergency stops trigger automatically for faults or watchdog timeouts."
                   TextColor="#ADB5BD"
                   FontSize="14"
                   LineHeight="1.4"
                   Margin="0,10,0,0" />
        </VerticalStackLayout>
    </ScrollView>

</ContentPage>
